---
title: "NARS Data Innovation Challenge"
author: "Linnea Rock"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(tidyverse)
library(colorblindr)
library(biogas)
library(patchwork)
library(spsurvey)
library(plotly)
library(inlmisc)
library(sf)
library(gt)
source("C:/Users/lrock1/Downloads/PhD_code/STOICH_NARSchallenge/Data/NLA/Call_NLA_data.R")
source("C:/Users/lrock1/Downloads/PhD_code/STOICH_NARSchallenge/Code/Functions/no_lakes_ts.R")
source("C:/Users/lrock1/Downloads/PhD_code/STOICH_NARSchallenge/Code/Functions/percent_change_lakes_ts.R")
```

### What are the sizes of lakes sampled during the NLA? 
```{r, echo=FALSE, warning=FALSE, message=FALSE, include = FALSE}
lake_size <- all_NLA |>
  select(UNIQUE_ID, AREA_HA, year, LAKE_ORIGIN, URBAN) |>
  distinct() |>
  mutate(size = NA) |>
  mutate(size = ifelse(AREA_HA <= 4, "<=4 ha",
                      ifelse(between(AREA_HA, 4, 10), "4-10 ha",
                             ifelse(between(AREA_HA, 10, 20), "10-20 ha",
                                    ifelse(between(AREA_HA, 20, 50), "20-50 ha",
                                    ifelse(between(AREA_HA, 50, 100), "50-100 ha", 
                                    ifelse(between(AREA_HA, 100, 1000), "100-1000 ha",
                                           ifelse(AREA_HA > 1000, ">1000 ha", size))))))))
lake_size$size = factor(lake_size$size,
                        levels = c("<=4 ha", "4-10 ha", "10-20 ha", "20-50 ha", "50-100 ha", "100-1000 ha", ">1000 ha"))

lake_size_plot <- ggplot(lake_size) +
  geom_bar(aes(size, fill = year)) +
  theme_minimal() +
  scale_fill_manual("Year", values = palette_OkabeIto[5:7]) +
  labs(x = "Lake Size",
       y = "# Lakes Sampled")

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
lake_size_plot

#Minimum lake size is:
min <- round(min(lake_size$AREA_HA), 2)

#Maximum lake size is:
max <- round(max(lake_size$AREA_HA), 2)

#Median lake size is:
median <- round(median(lake_size$AREA_HA),2)

#Mean lake size is:
mean <- round(mean(lake_size$AREA_HA), 2)

#number man-made lakes:

```


- minimum lake size is `r min` ha
- maximum lake size is `r max` ha
- median lake size is `r median` ha
- mean lake size is `r mean` ha



### Locations of lakes sampled in 2017
#### Lakes colored by trophic status

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=6.5, fig.height=4.5}
regions.sf <- read_sf("C:/Users/lrock1/Downloads/PhD_code/STOICH_NARSchallenge/Data/aggr_ecoregions_2015/Aggr_Ecoregions_2015.shp")
nla_locations.sf <- st_as_sf(all_NLA, coords = c("LON_DD", "LAT_DD"), crs = 4326)

inlmisc::GetColors(9, scheme = "muted")
pal <- c("#CC6677", "#332288", "#DDCC77", "#117733", "#88CCEE", "#882255" ,"#44AA99" ,"#999933", "#AA4499")


TS <- ggplot() +
  geom_sf(data = regions.sf, aes(fill = WSA9_NAME), alpha = 0.35) +
  geom_sf(data = nla_locations.sf |> filter(year == 2017, !is.na(TSTATE_CHL)), aes(color = TSTATE_CHL), size = 2) +
  theme_minimal() +
  scale_fill_manual("", values = pal) +
  scale_color_manual("", values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1]),
                     labels = c("Olig.", "Meso.", "Eutro.", "Hyper.")) 

TS

```


#### Logged TN:TP molar ratios across the US in 2017

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=6.5, fig.height=4.5}
NP <- ggplot() +
  geom_sf(data = regions.sf, aes(fill = WSA9_NAME), alpha = 0.25) +
  geom_sf(data = nla_locations.sf |> filter(year == 2017), aes(color = log10(tn.tp)), size = 2) +
  theme_minimal() +
  scale_fill_manual("", values = pal) +
  #scale_fill_manual("", values = c(palette_OkabeIto_black[], '#FFFFFF')) +
  scale_color_viridis_c('Log10 TN:TP molar ratio')

NP

```


### Trophic states across US ecoregions

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=6.5, fig.height=4.5}
ggplot(all_NLA |> filter(!is.na(TSTATE_CHL))) +
  geom_bar(aes(ECO_REG, fill = TSTATE_CHL)) +
  theme_minimal() +
  scale_fill_manual("", values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1]),
                    labels = c("Olig.", "Meso.", "Eutro.", "Hyper.")) +
  labs(x = "",
       y = "# Lakes in each trophic category")
```


### N and P limitations from the literature.

#### Looking at the NLA data with N and P limits from Bergström, 2010. The predicted limitations are above/below the dotted lines. The red line is the Redfield 16:1 line. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(log(PTL_PPB, base = 10), log(tn.tp, base = 10), fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  geom_abline(slope = 0, intercept = log(19, base = 10), linetype = "dashed") +
  geom_abline(slope = 0, intercept = log(28, base = 10)) +
  geom_abline(slope = 0, intercept = log(41, base = 10), linetype = "dashed") +
  geom_abline(slope = 0, intercept = log(16, base = 10), color = "red") +
  theme_minimal() +
  scale_fill_manual("Year",values = palette_OkabeIto[5:7]) +
  labs(y = "Log TN:TP", x = "Log TP"~(mu*g~L^-1)) +
  annotate('text', label = 'Redfield 16:1 line', x = 3.5, y = 1.1, hjust = 0, size = 3, color = "red") +
  annotate('text', label = 'Predicted N limitation \n (Bergström, 2010)', x = -1, y = 1, hjust = 0, size = 3) +
  annotate('text', label = 'Predicted P limitation \n (Bergström, 2010)', x = 3, y = 2, hjust = 0, size = 3) 
```


#### From Downing and McCauley, 1992. N limitation singificantly occurs when TN:TP <= 14 and when TP > 30 ug/L

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(log(PTL_PPB, base = 10), log(tn.tp, base = 10), fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  geom_vline(xintercept = log(30, base = 10)) +
  geom_abline(slope = 0, intercept = log(14, base = 10)) +
  theme_minimal() +
  scale_fill_manual("Year",values = palette_OkabeIto[5:7]) +
  labs(y = "Log TN:TP", x = "Log TP"~(mu*g~L^-1)) +
  annotate('text', label = 'N limitation likely \n (Dodds & McCauley, 1992)', x = 2.5, y = -0.25, hjust = 0, size = 3) +
  annotate('text', label = 'TP = 30'~(mu*g~L^-1), x = 0.9, y = -0.25, hjust = 0, size = 3) +
  annotate('text', label = 'TN:TP = 14', x = -0.5, y = 1, hjust = 0, size = 3) 
```


### Nitrogen vs. Phosphorus and Trophic Status


Note: the axes are logged in these figures

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(TP_mol, TN_mol, fill = TSTATE_CHL), size = 2.5, shape = 21, alpha = 0.8) +
 # geom_abline(slope = 16, intercept = 0) +
  theme_minimal() +
  scale_fill_manual(values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  theme(legend.title = element_blank()) +
        #legend.position = 'bottom') +
  labs(x = "TP (molar)", y = "TN (molar)", title = "Trophic Status based on Chlorophyll") +
  #annotate('text', label = 'Redfield 16:1 line', x = 0.0001, y = 0.0015, hjust = 0, size = 4) +
  scale_y_log10() +
  scale_x_log10() 
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
# conversions for concentration to molar N, P
Pmol <- molMass("P") * 1000000 #ug/mol
Nmol <- molMass("N") * 1000 #mg/mol

ggplot(all_NLA) +
  geom_point(aes(TP_mol, TN_mol, fill = year), size = 2.5, shape = 21, alpha = 0.3) +
  geom_vline(xintercept = 10/Pmol, base = 10) + # oligotrophic under 10 ug/L TP
  geom_vline(xintercept = 25/Pmol, base = 10) + # mesotrophic 10-25 ug/L TP
  geom_vline(xintercept = 100/Pmol, base = 10) + # eutrophic 25-100 ug/L TP, hypereutrophic greater than 100 ug/L TP
  geom_hline(yintercept = 0.35/Nmol, base = 10, color = "#cc79a7") +# oligotrophic under 0.35 mg/L TN
  geom_hline(yintercept = 0.75/Nmol, base = 10, color = "#cc79a7") +# mesotrophic 0.35-0.75 mg/L TN
  geom_hline(yintercept = 1.4/Nmol, base = 10, color = "#cc79a7") +# eutrophic 0.75-1.4 mg/L TN, hypereutrophic greater than 1.4 mg/L TN
  theme_minimal() +
  scale_fill_manual(values = palette_OkabeIto[5:7]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TP (molar)", y = "TN (molar)", title = "Trophic Status based on TN and TP") +
  annotate('text', label = 'TP<10 ug/L', x = 0.0000001, y = 0.005, hjust = 0, size = 3) +
  annotate('text', label = '25>\nTP\n>10', x = 0.0000004, y = 0.004, hjust = 0, size = 3) +
  annotate('text', label = '100>TP>25', x = 0.0000009, y = 0.005, hjust = 0, size = 3) +
  annotate('text', label = 'TP>100 ug/L', x = 0.000004, y = 0.005, hjust = 0, size = 3) +
  annotate('text', label = 'TN>1.4 mg/L', x = 0.7e-08, y = 0.00015, hjust = 0, size = 3, color = "#cc79a7") +
  annotate('text', label = '1.4>TN>0.75', x = 0.7e-08, y = 0.00008, hjust = 0, size = 3, color = "#cc79a7") +
  annotate('text', label = '0.75>TN>0.35', x = 0.7e-08, y = 0.00004, hjust = 0, size = 3, color = "#cc79a7") +
  annotate('text', label = 'TN<0.35 mg/L', x = 0.7e-08, y = 0.00002, hjust = 0, size = 3, color = "#cc79a7") +
  scale_y_log10() +
  scale_x_log10() 
```


### Nutrient relationships with Chlorophyll


Note: axes are logged in these figures

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(PTL_PPB, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_minimal() +
  scale_fill_manual(values = palette_OkabeIto[5:7]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TP"~(mu*g~L^-1), y = "Chlorophyll"~(mu*g~L^-1), title = "Chl vs TP") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(NTL_PPM, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_minimal() +
  scale_fill_manual(values = palette_OkabeIto[5:7]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TN"~(mg~L^-1), y = "Chlorophyll"~(mu*g~L^-1), title = "Chl vs TN") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(DIN_PPM, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_minimal() +
  scale_fill_manual(values = palette_OkabeIto[5:7]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "DIN"~(mg~L^-1), y = "Chlorophyll"~(mu*g~L^-1), title = "Chl vs DIN") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(tn.tp, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_minimal() +
  scale_fill_manual(values = palette_OkabeIto[5:7]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TN:TP (molar)", y = "Chlorophyll"~(mu*g~L^-1), title = "Chl vs TN:TP") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(DIN_mol/TP_mol, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_minimal() +
  scale_fill_manual(values = palette_OkabeIto[5:7]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "DIN:TP (molar)", y = "Chlorophyll"~(mu*g~L^-1), title = "Chl vs DIN:TP") +
  scale_y_log10() +
  scale_x_log10() 
```


### Number of lakes in each trophic category


```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ts <- all_NLA |>
  select(UNIQUE_ID, year, WGT_NLA, ECO_REG_NAME, TSTATE_CHL, TSTATE_TP, TSTATE_TN, LAT_DD, LON_DD) |>
  mutate(WGT_NLA = ifelse(WGT_NLA == 0, 1, WGT_NLA)) # the package I'm using to analyze number of lakes in each category along with the percent of lakes represented requires weights to be all positive numbers. I'm not sure why there are zeros here at all... they should be representative of at least themselves. 

chla_trophic_states <- no_lakes_ts(ts, "TSTATE_CHL") |> # And do all this dumb formatting
  filter(Category != "Total") |>
  mutate(fill_column = paste(nResp, "(", round(Estimate.P, 1), "±", round(StdError.P, 1), ")")) |>
  mutate(column_names = paste(Category, ".", year)) |>
  pivot_wider(id_cols = c(Subpopulation), names_from = "column_names", values_from = "fill_column")


#make the table

#this is not exactly what I want for my table, but it is close enough for now
chla_trophic_states |>
  group_by(Subpopulation) |>
  gt() |>
  tab_spanner_delim(delim = ".")
# 
# chla_tbl <- gt(chla_trophic_states)
# chla_ts_table <- chla_tbl |>
#   cols_label(
#     Subpopulation = "Ecoregion"
#     ) |>
#   tab_spanner(chla_tbl |> filter(Category == "OLIGOTROPHIC (<= 2 ug/L)"), label = "Oligotrophic", columns = vars(`2007`, `2012`, `2017`));chla_ts_table

```


### How have the lakes changed trophic category over the years?
#### Looking at the difference between 2017 and 2007

```{r, echo=FALSE, warning=FALSE, message=FALSE, include = FALSE}

chla_total_change0717 <- change_lakes_ts(ts, "TSTATE_CHL", "2007", "2017")

nat.plot.chla <- plot_change_national(chla_total_change0717, "2007", "2017")
  
regional.plot.chla <- plot_change_regional(chla_total_change0717, "2007", "2017")

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height= 8.5}

nat.plot.chla / regional.plot.chla

```
<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<!-- ### Number of lakes in each trophic category (according to TP status) -->

<!-- ```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5} -->

<!-- TP_trophic_states <- no_lakes_ts(ts, "TSTATE_TP") |> # And do all this dumb formatting -->
<!--   filter(Category != "Total") |> -->
<!--   mutate(fill_column = paste(nResp, "(", round(Estimate.P, 1), "±", round(StdError.P, 1), ")")) |> -->
<!--   mutate(column_names = paste(Category, ".", year)) |> -->
<!--   pivot_wider(id_cols = c(Subpopulation), names_from = "column_names", values_from = "fill_column") -->

<!-- #make the table -->

<!-- #this is not exactly what I want for my table, but it is close enough for now -->
<!-- TP_trophic_states |> -->
<!--   group_by(Subpopulation) |> -->
<!--   gt() |> -->
<!--   tab_spanner_delim(delim = ".") -->

<!-- ``` -->



<!-- ### How have the lakes changed trophic category (according to TP status) over the years? -->
<!-- Looking at the difference between 2017 and 2007 -->

<!-- ```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height= 8.5} -->

<!-- TP_total_change0717 <- change_lakes_ts(ts, "TSTATE_TP", "2007", "2017") -->

<!-- nat.plot.TP <- plot_change_national(TP_total_change0717, "2007", "2017") -->

<!-- regional.plot.TP <- plot_change_regional(TP_total_change0717, "2007", "2017") -->


<!-- nat.plot.TP / regional.plot.TP -->


<!-- ``` -->


<!-- ### Number of lakes in each trophic category (according to TN status) -->
<!-- ```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5} -->
<!-- TN_trophic_states <- no_lakes_ts(ts, "TSTATE_TN") |> # And do all this dumb formatting -->
<!--   filter(Category != "Total") |> -->
<!--   mutate(fill_column = paste(nResp, "(", round(Estimate.P, 1), "±", round(StdError.P, 1), ")")) |> -->
<!--   mutate(column_names = paste(Category, ".", year)) |> -->
<!--   pivot_wider(id_cols = c(Subpopulation), names_from = "column_names", values_from = "fill_column") -->

<!-- #make the table -->

<!-- #this is not exactly what I want for my table, but it is close enough for now -->
<!-- TN_trophic_states |> -->
<!--   group_by(Subpopulation) |> -->
<!--   gt() |> -->
<!--   tab_spanner_delim(delim = ".") -->

<!-- ``` -->


<!-- ### How have the lakes changed trophic category (according to TN status) over the years? -->
<!-- Looking at the difference between 2017 and 2007 -->

<!-- ```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height= 8.5} -->

<!-- TN_total_change0717 <- change_lakes_ts(ts, "TSTATE_TN", "2007", "2017") -->

<!-- nat.plot.TN <- plot_change_national(TN_total_change0717, "2007", "2017") -->

<!-- regional.plot.TN <- plot_change_regional(TN_total_change0717, "2007", "2017") -->


<!-- nat.plot.TN / regional.plot.TN -->


<!-- ``` -->
<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

### How have TN:TP ratios changed over the years?
#### Table and figure showing changes in TN:TP, TN, TP, Chla across the years
 I can't add these until I determine what to do with double samplings 
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}

#2007-2012
# dat_tntp <- all_NLA |>
#   filter(year %in% c("2007", "2012")) |>
#   select(UNIQUE_ID, year, tn.tp) |>
#   pivot_wider(names_from = year, values_from = tn.tp) 

## can't make this until I determine what to do with double samplings


```


### Boxplots showing how concentrations and ratios vary across trophic states in the most recent NLA survey (2017)

#### Trophic states based on chlorophyll 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
#2017 data
NLA17_boxplots <- NLA17 |>
    mutate(TSTATE_CHL = ifelse(startsWith(TSTATE_CHL, "OLIGOTROPHIC"), "Oligo.",
                             ifelse(startsWith(TSTATE_CHL, "MESOTROPHIC"), "Meso.", 
                                    ifelse(startsWith(TSTATE_CHL,"EUTROPHIC"), "Eutro.",
                                           ifelse(startsWith(TSTATE_CHL, "HYPEREUTROPHIC"), "Hyper.", TSTATE_CHL))))) |>
    mutate(TSTATE_CHL = factor(TSTATE_CHL, levels = c("Oligo.", "Meso.", "Eutro.", "Hyper."))) 

pta <- ggplot(NLA17_boxplots) +
  geom_boxplot(aes(TSTATE_CHL, tn.tp, fill = TSTATE_CHL)) +
  theme_minimal() +
  scale_fill_manual(values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "TN:TP Molar Ratio")

ptb <- ggplot(NLA17_boxplots) +
  geom_boxplot(aes(TSTATE_CHL, DIN_mol/TP_mol, fill = TSTATE_CHL)) +
  theme_minimal() +
  scale_fill_manual(values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "DIN:TP Molar Ratio")
  
ptc <- ggplot(NLA17_boxplots) +
  geom_boxplot(aes(TSTATE_CHL, NTL_PPM, fill = TSTATE_CHL)) +
  theme_minimal() +
  scale_fill_manual(values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "TN"~(mg~L^-1))

ptd <- ggplot(NLA17_boxplots) +
  geom_boxplot(aes(TSTATE_CHL, PTL_PPB, fill = TSTATE_CHL)) +
  theme_minimal() +
  scale_fill_manual(values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "TP"~(mu*g~L^-1))

pte <- ggplot(NLA17_boxplots) +
  geom_boxplot(aes(TSTATE_CHL, DIN_PPM, fill = TSTATE_CHL)) +
  theme_minimal() +
  scale_fill_manual(values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "DIN"~(mg~L^-1))

ptf <- ggplot(NLA17_boxplots) +
  geom_boxplot(aes(TSTATE_CHL, CHLA_PPB, fill = TSTATE_CHL)) +
  theme_minimal() +
  scale_fill_manual(values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "Chlorophyll-a"~(mu*g~L^-1))


( (pta | ptb) /
  (ptc | ptd) /
  (pte | ptf) )+
  plot_annotation(tag_levels = 'a')

```


### Comparisons between years in resampled lakes

#### TN:TP ratio differences between 2007 and 2017. Red line is 1:1, or no change.
Note: there are a lot of doubles here. I need to determine what to do about lakes that are sampled twice.


```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
comparison <- NLA07 |>
  select(UNIQUE_ID, tn.tp, NTL_PPM, PTL_PPB, CHLA_PPB) |>
  rename(tn.tp_2007 = tn.tp,
         NTL_PPM_2007 = NTL_PPM,
         PTL_PPB_2007 = PTL_PPB,
         CHLA_PPB_2007 = CHLA_PPB)

temp.17 <- NLA17 |>
  select(UNIQUE_ID, tn.tp, NTL_PPM, PTL_PPB, CHLA_PPB) |>
  rename(tn.tp_2017 = tn.tp,
         NTL_PPM_2017 = NTL_PPM,
         PTL_PPB_2017 = PTL_PPB,
         CHLA_PPB_2017 = CHLA_PPB)

comparison <- inner_join(comparison, temp.17)

p1 <- ggplot(comparison) +
  geom_point(aes(tn.tp_2007, tn.tp_2017)) +
  theme_minimal() +
  #scale_color_manual(values = "black") +
  theme(legend.position = "none") +
  labs(x = "2007 value",
       y = "2017 value",
       title = "TN:TP molar ratio") +
  geom_abline(slope = 1, intercept = 0, color = "red3")


p2 <- ggplot(comparison) +
  geom_point(aes(NTL_PPM_2007, NTL_PPM_2017)) +
  theme_minimal() +
  #scale_color_manual(values = "black") +
  theme(legend.position = "none") +
    labs(x = "2007 value",
       y = "2017 value",
       title = "Total Nitrogen"~(mg~L^-1)) +
  geom_abline(slope = 1, intercept = 0, color = "red3")

p3 <- ggplot(comparison) +
  geom_point(aes(PTL_PPB_2007, PTL_PPB_2017)) +
  theme_minimal() +
  #scale_color_manual(values = "black") +
  theme(legend.position = "none") +
  theme(legend.position = "none") +
    labs(x = "2007 value",
       y = "2017 value",
       title = "Total Phosphorus"~(mu*g~L^-1)) +
  geom_abline(slope = 1, intercept = 0, color = "red3")

p4 <- ggplot(comparison) +
  geom_point(aes(CHLA_PPB_2007, CHLA_PPB_2017)) +
  theme_minimal() +
  #scale_color_manual(values = "black") +
  theme(legend.position = "none") +
    labs(x = "2007 value",
       y = "2017 value",
       title = "Chlorophyll-a"~(mu*g~L^-1)) +
  geom_abline(slope = 1, intercept = 0, color = "red3")

(p1 | p4) / (p2 | p3)

```



### How do trophic statuses and stoichiometries compare across ecoregions in natural vs. manmade lakes in 2017? 

#### Logged axes

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=8.5}
#filter the dataset
ts_laketype <- all_NLA |>
  select(URBAN, LAKE_ORIGIN, TSTATE_CHL, ECO_REG_NAME, year, tn.tp, DIN_mol, TP_mol) |>
  mutate(din.tp = DIN_mol/TP_mol) |>
  select(-DIN_mol, -TP_mol) 

# #2007
# ggplot(ts_laketype |> filter(!is.na(TSTATE_CHL),
#                              year == 2007)) +
#   geom_violin(aes(y = tn.tp, x = LAKE_ORIGIN,  fill = TSTATE_CHL)) +
#   #geom_jitter(aes(y = tn.tp, x = LAKE_ORIGIN, shape = URBAN, color = TSTATE_CHL, group = TSTATE_CHL), size = 1) +
#   scale_y_log10() +
#   theme_minimal() +
#   scale_fill_manual("", values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
#   labs(y = "TN:TP molar ratio",
#        x = "Lake Type",
#        title = "2007")
# 
# #2012
# ggplot(ts_laketype |> filter(!is.na(TSTATE_CHL),
#                              year == 2012)) +
#   geom_violin(aes(y = tn.tp, x = LAKE_ORIGIN,  fill = TSTATE_CHL)) +
#   #geom_jitter(aes(y = tn.tp, x = LAKE_ORIGIN, shape = URBAN, color = TSTATE_CHL, group = TSTATE_CHL), size = 1) +
#   scale_y_log10() +
#   theme_minimal() +
#   scale_fill_manual("", values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
#   labs(y = "TN:TP molar ratio",
#        x = "Lake Type",
#        title = "2012")

#2017
p1 <- ggplot(ts_laketype |> filter(!is.na(TSTATE_CHL),
                             year == 2017)) +
  geom_violin(aes(y = tn.tp, x = LAKE_ORIGIN,  fill = TSTATE_CHL)) +
  #geom_jitter(aes(y = tn.tp, x = LAKE_ORIGIN, shape = URBAN, color = TSTATE_CHL, group = TSTATE_CHL), size = 1) +
  scale_y_log10() +
  theme_minimal() +
  theme(legend.position = "bottom") +
  scale_fill_manual("", values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1]),
                    labels = c("Olig.", "Meso.", "Eutro.", "Hyper.")) +
  labs(y = "TN:TP molar ratio",
       x = "Lake Type",
       title = "National")

p2 <- ggplot(ts_laketype |> filter(!is.na(TSTATE_CHL),
                             year == 2017)) +
  geom_violin(aes(y = tn.tp, x = LAKE_ORIGIN,  fill = TSTATE_CHL)) +
  #geom_jitter(aes(y = tn.tp, x = LAKE_ORIGIN, shape = URBAN, color = TSTATE_CHL, group = TSTATE_CHL), size = 1) +
  scale_y_log10() +
  theme_bw() +
  theme(legend.position = "none") +
  scale_fill_manual("", values = c(palette_OkabeIto[2], palette_OkabeIto[4], palette_OkabeIto[3], palette_OkabeIto[1])) +
  labs(y = "TN:TP molar ratio",
       x = "Lake Type") +
  facet_wrap(~ECO_REG_NAME, ncol = 3)

p1/p2

```




