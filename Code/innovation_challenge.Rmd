---
title: "NARS Data Innovation Challenge"
author: "Linnea Rock"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(tidyverse)
library(colorblindr)
library(biogas)
source("C:/Users/linne/Downloads/PhD_code/STOICH_NARSchallenge/Data/NLA/Call_NLA_data.R")
```

## Some basics about the NLA datasets


### What are the sizes of lakes sampled during the NLA? 
```{r, echo=FALSE, warning=FALSE, message=FALSE, include = FALSE}
lake_size <- all_NLA |>
  select(UNIQUE_ID, AREA_HA, year) |>
  distinct() |>
  mutate(size = NA) |>
  mutate(size = ifelse(AREA_HA <= 4, "<=4 ha",
                      ifelse(between(AREA_HA, 4, 10), "4-10 ha",
                             ifelse(between(AREA_HA, 10, 20), "10-20 ha",
                                    ifelse(between(AREA_HA, 20, 50), "20-50 ha",
                                    ifelse(between(AREA_HA, 50, 100), "50-100 ha", 
                                    ifelse(between(AREA_HA, 100, 1000), "100-1000 ha",
                                           ifelse(AREA_HA > 1000, ">1000 ha", size))))))))
lake_size$size = factor(lake_size$size,
                        levels = c("<=4 ha", "4-10 ha", "10-20 ha", "20-50 ha", "50-100 ha", "100-1000 ha", ">1000 ha"))

lake_size_plot <- ggplot(lake_size) +
  geom_bar(aes(size, fill = year)) +
  theme_light() +
  scale_fill_manual("Year", values = palette_OkabeIto[]) +
  labs(x = "Lake Size",
       y = "# Lakes Sampled")

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
lake_size_plot

#Minimum lake size is:
min <- round(min(lake_size$AREA_HA), 2)

#Maximum lake size is:
max <- round(max(lake_size$AREA_HA), 2)

#Median lake size is:
median <- round(median(lake_size$AREA_HA),2)

#Mean lake size is:
mean <- round(mean(lake_size$AREA_HA), 2)
```


- minimum lake size is `r min` ha
- maximum lake size is `r max` ha
- median lake size is `r median` ha
- mean lake size is `r mean` ha


### N and P limitations from the literature.

#### Looking at the NLA data with N and P limits from Bergström, 2010. The predicted limitations are above/below the dotted lines. The red line is the Redfield 16:1 line. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(log(PTL_PPB, base = 10), log(tn.tp, base = 10), fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  geom_abline(slope = 0, intercept = log(19, base = 10), linetype = "dashed") +
  geom_abline(slope = 0, intercept = log(28, base = 10)) +
  geom_abline(slope = 0, intercept = log(41, base = 10), linetype = "dashed") +
  geom_abline(slope = 0, intercept = log(16, base = 10), color = "red") +
  theme_light() +
  scale_fill_manual("Year",values = palette_OkabeIto[]) +
  labs(y = "Log TN:TP", x = "Log TP"~(mu~g~L^-1)) +
  annotate('text', label = 'Redfield 16:1 line', x = 3.5, y = 1.1, hjust = 0, size = 3, color = "red") +
  annotate('text', label = 'Predicted N limitation \n (Bergström, 2010)', x = -1, y = 1, hjust = 0, size = 3) +
  annotate('text', label = 'Predicted P limitation \n (Bergström, 2010)', x = 3, y = 2, hjust = 0, size = 3) 
```


#### From Downing and McCauley, 1992. N limitation singificantly occurs when TN:TP <= 14 and when TP > 30 ug/L

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(log(PTL_PPB, base = 10), log(tn.tp, base = 10), fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  geom_vline(xintercept = log(30, base = 10)) +
  geom_abline(slope = 0, intercept = log(14, base = 10)) +
  theme_light() +
  scale_fill_manual("Year",values = palette_OkabeIto[]) +
  labs(y = "Log TN:TP", x = "Log TP"~(mu~g~L^-1)) +
  annotate('text', label = 'N limitation likely \n (Dodds & McCauley, 1992)', x = 2.5, y = -0.25, hjust = 0, size = 3) +
  annotate('text', label = 'TP = 30'~(mu~g~L^-1), x = 0.9, y = -0.25, hjust = 0, size = 3) +
  annotate('text', label = 'TN:TP = 14', x = -0.5, y = 1, hjust = 0, size = 3) 
```


### Nitrogen vs. Phosphorus and Trophic Status


Note: the axes are logged in these figures

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(TP_mol, TN_mol, fill = TSTATE_CHL), size = 2.5, shape = 21, alpha = 0.8) +
 # geom_abline(slope = 16, intercept = 0) +
  theme_light() +
  scale_fill_manual(values = palette_OkabeIto[]) +
  theme(legend.title = element_blank()) +
        #legend.position = 'bottom') +
  labs(x = "TP (molar)", y = "TN (molar)", title = "Trophic Status based on Chlorophyll") +
  #annotate('text', label = 'Redfield 16:1 line', x = 0.0001, y = 0.0015, hjust = 0, size = 4) +
  scale_y_log10() +
  scale_x_log10() 
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
# conversions for concentration to molar N, P
Pmol <- molMass("P") * 1000000 #ug/mol
Nmol <- molMass("N") * 1000 #mg/mol

ggplot(all_NLA) +
  geom_point(aes(TP_mol, TN_mol, fill = year), size = 2.5, shape = 21, alpha = 0.3) +
  geom_vline(xintercept = 10/Pmol, base = 10) + # oligotrophic under 10 ug/L TP
  geom_vline(xintercept = 25/Pmol, base = 10) + # mesotrophic 10-25 ug/L TP
  geom_vline(xintercept = 100/Pmol, base = 10) + # eutrophic 25-100 ug/L TP, hypereutrophic greater than 100 ug/L TP
  geom_hline(yintercept = 0.35/Nmol, base = 10, color = "#cc79a7") +# oligotrophic under 0.35 mg/L TN
  geom_hline(yintercept = 0.75/Nmol, base = 10, color = "#cc79a7") +# mesotrophic 0.35-0.75 mg/L TN
  geom_hline(yintercept = 1.4/Nmol, base = 10, color = "#cc79a7") +# eutrophic 0.75-1.4 mg/L TN, hypereutrophic greater than 1.4 mg/L TN
  theme_light() +
  scale_fill_manual(values = palette_OkabeIto[]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TP (molar)", y = "TN (molar)", title = "Trophic Status based on TN and TP") +
  annotate('text', label = 'TP<10 ug/L', x = 0.0000001, y = 0.005, hjust = 0, size = 3) +
  annotate('text', label = '25>\nTP\n>10', x = 0.0000004, y = 0.004, hjust = 0, size = 3) +
  annotate('text', label = '100>TP>25', x = 0.0000009, y = 0.005, hjust = 0, size = 3) +
  annotate('text', label = 'TP>100 ug/L', x = 0.000004, y = 0.005, hjust = 0, size = 3) +
  annotate('text', label = 'TN>1.4 mg/L', x = 0.7e-08, y = 0.00015, hjust = 0, size = 3, color = "#cc79a7") +
  annotate('text', label = '1.4>TN>0.75', x = 0.7e-08, y = 0.00008, hjust = 0, size = 3, color = "#cc79a7") +
  annotate('text', label = '0.75>TN>0.35', x = 0.7e-08, y = 0.00004, hjust = 0, size = 3, color = "#cc79a7") +
  annotate('text', label = 'TN<0.35 mg/L', x = 0.7e-08, y = 0.00002, hjust = 0, size = 3, color = "#cc79a7") +
  scale_y_log10() +
  scale_x_log10() 
```


### Nutrient relationships with Chlorophyll


Note: axes are logged in these figures

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ggplot(all_NLA) +
  geom_point(aes(PTL_PPB, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_light() +
  scale_fill_manual(values = palette_OkabeIto[]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TP"~(mu~g~L^-1), y = "Chlorophyll"~(mu~g~L^-1), title = "Chl vs TP") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(NTL_PPM, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_light() +
  scale_fill_manual(values = palette_OkabeIto[]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TN"~(mg~L^-1), y = "Chlorophyll"~(mu~g~L^-1), title = "Chl vs TN") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(DIN_PPM, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_light() +
  scale_fill_manual(values = palette_OkabeIto[]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "DIN"~(mg~L^-1), y = "Chlorophyll"~(mu~g~L^-1), title = "Chl vs DIN") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(tn.tp, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_light() +
  scale_fill_manual(values = palette_OkabeIto[]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "TN:TP (molar)", y = "Chlorophyll"~(mu~g~L^-1), title = "Chl vs TN:TP") +
  scale_y_log10() +
  scale_x_log10() 


ggplot(all_NLA) +
  geom_point(aes(DIN_mol/TP_mol, CHLA_PPB, fill = year), size = 2.5, shape = 21, alpha = 0.8) +
  theme_light() +
  scale_fill_manual(values = palette_OkabeIto[]) +
  theme(legend.title = element_blank(),
        legend.position = 'bottom') +
  labs(x = "DIN:TP (molar)", y = "Chlorophyll"~(mu~g~L^-1), title = "Chl vs DIN:TP") +
  scale_y_log10() +
  scale_x_log10() 
```


### Number of lakes in each trophic category (according to Chlorophyll status)


```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
ts <- all_NLA |>
  select(UNIQUE_ID, year, WGT_NLA, ECO_REG_NAME, TSTATE_CHL, TSTATE_TP, TSTATE_TN, LAT_DD, LON_DD) |>
  mutate(WGT_NLA = ifelse(WGT_NLA == 0, 1, WGT_NLA)) # the package I'm using to analyze number of lakes in each category along with the percent of lakes represented requires weights to be all positive numbers. I'm not sure why there are zeros here at all... they should be representative of at least themselves. 

# use the SpSurvey package from EPA
library(spsurvey)
citation("spsurvey")

# 2007
chla_2007_ecoreg <- cat_analysis(ts |> filter(year == 2007), subpop = "ECO_REG_NAME", vars = "TSTATE_CHL", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

chla_2007_ecoreg.1 <- chla_2007_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2007)

# 2012
chla_2012_ecoreg <- cat_analysis(ts |> filter(year == 2012), subpop = "ECO_REG_NAME", vars = "TSTATE_CHL", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

chla_2012_ecoreg.1 <- chla_2012_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2012)

# 2017
chla_2017_ecoreg <- cat_analysis(ts |> filter(year == 2017), subpop = "ECO_REG_NAME", vars = "TSTATE_CHL", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

chla_2017_ecoreg.1 <- chla_2017_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2017)

chla_national <- cat_analysis(ts, vars = "TSTATE_CHL", subpop = "year", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

chla_national.1 <- chla_national|>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = Subpopulation,
         Subpopulation = "National")

chla_trophic_states <- rbind(chla_national.1, chla_2007_ecoreg.1, chla_2012_ecoreg.1, chla_2017_ecoreg.1) |>
  filter(Category != "Total") |>
  mutate(fill_column = paste(nResp, "(", round(Estimate.P, 1), "±", round(StdError.P, 1), ")")) |>
  pivot_wider(id_cols = c(Subpopulation, Category), names_from = "year", values_from = "fill_column")


#make the table
library(gt)

chla_tbl <- gt(chla_trophic_states)
chla_ts_table <- chla_tbl |>
  cols_label(
    Subpopulation = "Ecoregion"
    ) |>
  tab_spanner(label = "Oligotrophic", columns = vars(`2007`, `2012`, `2017`));chla_ts_table

```



### Number of lakes in each trophic category (according to TP status)

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
# 2007
TP_2007_ecoreg <- cat_analysis(ts |> filter(year == 2007), subpop = "ECO_REG_NAME", vars = "TSTATE_TP", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TP_2007_ecoreg.1 <- TP_2007_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2007)

# 2012
TP_2012_ecoreg <- cat_analysis(ts |> filter(year == 2012), subpop = "ECO_REG_NAME", vars = "TSTATE_TP", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TP_2012_ecoreg.1 <- TP_2012_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2012)

# 2017
TP_2017_ecoreg <- cat_analysis(ts |> filter(year == 2017), subpop = "ECO_REG_NAME", vars = "TSTATE_TP", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TP_2017_ecoreg.1 <- TP_2017_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2017)

TP_national <- cat_analysis(ts, vars = "TSTATE_TP", subpop = "year", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TP_national.1 <- TP_national|>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = Subpopulation,
         Subpopulation = "National")

TP_trophic_states <- rbind(TP_national.1, TP_2007_ecoreg.1, TP_2012_ecoreg.1, TP_2017_ecoreg.1) |>
  filter(Category != "Total")

```




### Number of lakes in each trophic category (according to TN status)
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=4.5}
# 2007
TN_2007_ecoreg <- cat_analysis(ts |> filter(year == 2007), subpop = "ECO_REG_NAME", vars = "TSTATE_TN", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TN_2007_ecoreg.1 <- TN_2007_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2007)

# 2012
TN_2012_ecoreg <- cat_analysis(ts |> filter(year == 2012), subpop = "ECO_REG_NAME", vars = "TSTATE_TN", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TN_2012_ecoreg.1 <- TN_2012_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2012)

# 2017
TN_2017_ecoreg <- cat_analysis(ts |> filter(year == 2017), subpop = "ECO_REG_NAME", vars = "TSTATE_TN", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TN_2017_ecoreg.1 <- TN_2017_ecoreg |>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = 2017)

TN_national <- cat_analysis(ts, vars = "TSTATE_TN", subpop = "year", weight = "WGT_NLA", xcoord = "LON_DD", ycoord = "LAT_DD")

TN_national.1 <- TN_national|>
  select(Subpopulation, Category, nResp, Estimate.P, StdError.P) |>
  mutate(year = Subpopulation,
         Subpopulation = "National")

TN_trophic_states <- rbind(TN_national.1, TN_2007_ecoreg.1, TN_2012_ecoreg.1, TN_2017_ecoreg.1) |>
  filter(Category != "Total")

```


